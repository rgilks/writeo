name: Deploy Modal Services

on:
  push:
    branches:
      - main
    paths:
      - 'services/modal-deberta/**'
      - 'services/modal-lt/**'
      - 'services/modal-gec/**'
      - 'packages/shared/py/**'
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      modal-deberta: ${{ steps.changes.outputs.modal-deberta }}
      modal-lt: ${{ steps.changes.outputs.modal-lt }}
      modal-gec: ${{ steps.changes.outputs.modal-gec }}

      modal-feedback: ${{ steps.changes.outputs.modal-feedback }}
      modal-gector: ${{ steps.changes.outputs.modal-gector }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - deploy all services
            echo "modal-deberta=true" >> $GITHUB_OUTPUT
            echo "modal-lt=true" >> $GITHUB_OUTPUT
            echo "modal-gec=true" >> $GITHUB_OUTPUT

            echo "modal-feedback=true" >> $GITHUB_OUTPUT
            echo "modal-gector=true" >> $GITHUB_OUTPUT
          else
            # Get the base commit (use merge-base for PRs, or HEAD^1 for pushes)
            BASE_SHA="${{ github.event.before }}"
            if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" == "0000000000000000000000000000000000000000" ]; then
              BASE_SHA="HEAD^1"
            fi
            
            # Check for changes in modal-deberta
            if git diff --name-only "$BASE_SHA" "${{ github.sha }}" | grep -qE "^services/modal-deberta/|^packages/shared/py/"; then
              echo "modal-deberta=true" >> $GITHUB_OUTPUT
            else
              echo "modal-deberta=false" >> $GITHUB_OUTPUT
            fi
            
            # Check for changes in modal-lt
            if git diff --name-only "$BASE_SHA" "${{ github.sha }}" | grep -qE "^services/modal-lt/|^packages/shared/py/"; then
              echo "modal-lt=true" >> $GITHUB_OUTPUT
            else
              echo "modal-lt=false" >> $GITHUB_OUTPUT
            fi
            
            # Check for changes in modal-gec
            if git diff --name-only "$BASE_SHA" "${{ github.sha }}" | grep -qE "^services/modal-gec/"; then
              echo "modal-gec=true" >> $GITHUB_OUTPUT
            else
              echo "modal-gec=false" >> $GITHUB_OUTPUT
            fi



            # Check for changes in modal-feedback
            if git diff --name-only "$BASE_SHA" "${{ github.sha }}" | grep -qE "^services/modal-feedback/|^packages/shared/py/"; then
              echo "modal-feedback=true" >> $GITHUB_OUTPUT
            else
              echo "modal-feedback=false" >> $GITHUB_OUTPUT
            fi

            # Check for changes in modal-gector
            if git diff --name-only "$BASE_SHA" "${{ github.sha }}" | grep -qE "^services/modal-gector/"; then
              echo "modal-gector=true" >> $GITHUB_OUTPUT
            else
              echo "modal-gector=false" >> $GITHUB_OUTPUT
            fi
          fi

  deploy-modal-deberta:
    needs: detect-changes
    if: needs.detect-changes.outputs.modal-deberta == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Modal CLI
        run: uv pip install --system modal

      - name: Authenticate with Modal
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          # Modal CLI automatically uses MODAL_TOKEN_ID and MODAL_TOKEN_SECRET env vars
          modal app list > /dev/null || echo "Authentication check complete"

      - name: Deploy Modal DeBERTa Service
        working-directory: services/modal-deberta
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          echo "Deploying Modal DeBERTa service..."
          modal deploy app.py

      - name: Extract Modal URL
        id: extract-url
        working-directory: services/modal-deberta
        run: |
          # Modal deploy outputs the URL, but we need to capture it
          # This is a best-effort extraction - the URL will be in the logs
          echo "Modal deployment completed. Check the logs above for the endpoint URL."
          echo "url=check-logs" >> $GITHUB_OUTPUT

  deploy-modal-lt:
    needs: detect-changes
    if: needs.detect-changes.outputs.modal-lt == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Modal CLI
        run: uv pip install --system modal

      - name: Authenticate with Modal
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          # Modal CLI automatically uses MODAL_TOKEN_ID and MODAL_TOKEN_SECRET env vars
          modal app list > /dev/null || echo "Authentication check complete"

      - name: Check if app.py exists
        id: check-app
        working-directory: services/modal-lt
        run: |
          if [ -f "app.py" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️  app.py not found in modal-lt. Skipping deployment."
            echo "   If you want to deploy modal-lt, create an app.py file similar to modal-essay."
          fi

      - name: Deploy Modal LanguageTool Service
        if: steps.check-app.outputs.exists == 'true'
        working-directory: services/modal-lt
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          echo "Deploying Modal LanguageTool service..."
          modal deploy app.py

  deploy-modal-gec:
    needs: detect-changes
    if: needs.detect-changes.outputs.modal-gec == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Modal CLI
        run: uv pip install --system modal

      - name: Authenticate with Modal
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          # Modal CLI automatically uses MODAL_TOKEN_ID and MODAL_TOKEN_SECRET env vars
          modal app list > /dev/null || echo "Authentication check complete"

      - name: Deploy Modal GEC Service
        working-directory: services/modal-gec
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          echo "Deploying Modal GEC service..."
          modal deploy main.py



  deploy-modal-feedback:
    needs: detect-changes
    if: needs.detect-changes.outputs.modal-feedback == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Modal CLI
        run: uv pip install --system modal

      - name: Authenticate with Modal
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          modal app list > /dev/null || echo "Authentication check complete"

      - name: Deploy Modal Feedback Service
        working-directory: services/modal-feedback
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          echo "Deploying Modal Feedback service..."
          modal deploy app.py

  deploy-modal-gector:
    needs: detect-changes
    if: needs.detect-changes.outputs.modal-gector == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install Modal CLI
        run: uv pip install --system modal

      - name: Authenticate with Modal
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          modal app list > /dev/null || echo "Authentication check complete"

      - name: Deploy Modal GECToR Service
        working-directory: services/modal-gector
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          echo "Deploying Modal GECToR service..."
          modal deploy main.py
